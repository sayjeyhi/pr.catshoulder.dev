name: Deploy WebContainer to GitHub Pages

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Create WebContainer HTML
        run: |
          mkdir -p pr-${{ github.event.pull_request.number }}
          cat > CNAME << 'EOF'
            {{ github.event.pull_request.number }}.pr.sayjeyhi.com
          EOF
          cat > pr-${{ github.event.pull_request.number }}/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="utf-8">
              <title>WebContainer Terminal - PR #${{ github.event.pull_request.number }}</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      margin: 0;
                      padding: 20px;
                      background: #f6f8fa;
                  }
                  .container {
                      max-width: 800px;
                      margin: 0 auto;
                      background: white;
                      border-radius: 8px;
                      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                      overflow: hidden;
                  }
                  .header {
                      background: #24292e;
                      color: white;
                      padding: 15px 20px;
                      font-weight: 600;
                  }
                  .terminal {
                      background: #1e1e1e;
                      color: #f8f8f2;
                      padding: 20px;
                      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
                      font-size: 14px;
                      line-height: 1.5;
                      min-height: 200px;
                      white-space: pre-wrap;
                      overflow-x: auto;
                  }
                  .loading { color: #61dafb; }
                  .error { color: #ff6b6b; }
                  .success { color: #51cf66; }
                  .command { color: #f8f8f2; }
                  .output { color: #a8ff60; }
                  .status {
                      background: #f1f3f4;
                      padding: 15px 20px;
                      border-top: 1px solid #e1e4e8;
                      font-size: 14px;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      üåê WebContainer Terminal - PR #${{ github.event.pull_request.number }}
                  </div>
                  <div class="terminal" id="terminal">
                      <div class="loading">Loading WebContainer...</div>
                  </div>
                  <div class="status" id="status">
                      Status: Initializing...
                  </div>
              </div>

              <script type="module">
                  import { WebContainer } from 'https://unpkg.com/@webcontainer/api@1.5.1/dist/index.js';
                  
                  const terminal = document.getElementById('terminal');
                  const status = document.getElementById('status');
                  
                  async function runWebContainer() {
                      try {
                          status.textContent = 'Status: Booting WebContainer...';
                          
                          const webcontainer = await WebContainer.boot();
                          
                          status.textContent = 'Status: WebContainer ready, running command...';
                          terminal.innerHTML = '<div class="command">$ echo "hello-world!"</div>';
                          
                          const process = await webcontainer.spawn('echo', ['hello-world!']);
                          const { code } = await process.exit;
                          
                          // Simple output capture
                          terminal.innerHTML += '<div class="output">hello-world!</div>';
                          
                          if (code === 0) {
                              status.innerHTML = '<span class="success">‚úÖ Command executed successfully</span> | Exit Code: ' + code;
                          } else {
                              status.innerHTML = '<span class="error">‚ùå Command failed</span> | Exit Code: ' + code;
                          }
                          
                      } catch (error) {
                          terminal.innerHTML += '<div class="error">Error: ' + error.message + '</div>';
                          status.innerHTML = '<span class="error">‚ùå WebContainer failed to start</span>';
                          console.error('WebContainer error:', error);
                      }
                  }
                  
                  runWebContainer();
              </script>
          </body>
          </html>
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './pr-${{ github.event.pull_request.number }}'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üåê WebContainer Terminal Preview
              
              **[üì± Open WebContainer Terminal](${{ steps.deployment.outputs.page_url }})**
              
              > This WebContainer runs in your browser using the [WebContainer API](https://webcontainers.io/).
              > 
              > **Features:**
              > - ‚úÖ Full terminal access
              > - ‚úÖ Browser-based execution
              > - ‚úÖ No server required
              
              ---
              <sup>Preview generated for PR #${{ github.event.pull_request.number }}</sup>`
            })
